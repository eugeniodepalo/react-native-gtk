#!/bin/sh

set -e

IMAGE_NAME=react-native-gtk4
CONTAINER_NAME=react-native-gtk4-codegen
OUT_DIR=$1

# Build the docker image to get the GIR files
docker build -t $IMAGE_NAME ../..
rm -rf girs
mkdir -p girs
docker rm -f $CONTAINER_NAME > /dev/null 2>&1 || true
docker run -d --name $CONTAINER_NAME --entrypoint /bin/bash -v ./girs:/girs $IMAGE_NAME -c 'sleep infinity' > /dev/null
docker exec $CONTAINER_NAME /bin/bash -c 'cp /usr/share/gir-1.0/*.gir /girs' > /dev/null
docker stop $CONTAINER_NAME > /dev/null
docker rm $CONTAINER_NAME > /dev/null

# Clean up the generated files
rm -rf $OUT_DIR/src/generated
rm -rf $OUT_DIR/__tests__/generated
mkdir -p $OUT_DIR/src/generated/widgets
mkdir -p $OUT_DIR/__tests__/generated/widgets

# Generate the GIR types
pnpm exec ts-for-gir generate Gtk-4.0 -g ./girs -e node -o $OUT_DIR/src/generated/girs
rm -f $OUT_DIR/src/generated/girs/*-import.js

# Generate the types
node dist/index.js $OUT_DIR

# Format the generated files
pnpm exec prettier --write $OUT_DIR/src/generated/**/*.{ts,tsx,js}
pnpm exec prettier --write $OUT_DIR/__tests__/generated/**/*.{ts,tsx,js}
